% \iffalse meta-comment
%% File: platexrelease.dtx
%
%  Copyright 2016 Japanese TeX Development Community.
%
%  This file is part of the pLaTeX2e system.
%  -----------------------------------------
%
% \fi
%
% \CheckSum{108}
%% \CharacterTable
%%  {Upper-case    \A\B\C\D\E\F\G\H\I\J\K\L\M\N\O\P\Q\R\S\T\U\V\W\X\Y\Z
%%   Lower-case    \a\b\c\d\e\f\g\h\i\j\k\l\m\n\o\p\q\r\s\t\u\v\w\x\y\z
%%   Digits        \0\1\2\3\4\5\6\7\8\9
%%   Exclamation   \!     Double quote  \"     Hash (number) \#
%%   Dollar        \$     Percent       \%     Ampersand     \&
%%   Acute accent  \'     Left paren    \(     Right paren   \)
%%   Asterisk      \*     Plus          \+     Comma         \,
%%   Minus         \-     Point         \.     Solidus       \/
%%   Colon         \:     Semicolon     \;     Less than     \<
%%   Equals        \=     Greater than  \>     Question mark \?
%%   Commercial at \@     Left bracket  \[     Backslash     \\
%%   Right bracket \]     Circumflex    \^     Underscore    \_
%%   Grave accent  \`     Left brace    \{     Vertical bar  \|
%%   Right brace   \}     Tilde         \~}
%%
%
% \iffalse
% \changes{v1.0}{2016/02/01}{first edition}
% \changes{v1.0a}{2016/02/03}{latexreleaseをもとにplatexreleaseとして拡張}
% \changes{v1.0b}{2016/02/16}{latexreleaseのバージョン確認を導入}
% \fi
%
% \iffalse
\NeedsTeXFormat{pLaTeX2e}
%<*driver>
\ProvidesFile{platexrelease.dtx}
%</driver>
%<platexrelease>\ProvidesPackage{platexrelease}
                [2016/02/16 v1.0b latexrelease support for pLaTeX Kernel]
%<*driver>
\documentclass{jltxdoc}
\GetFileInfo{platexrelease.dtx}
\author{Japanese \TeX\ Development Community}
\title{\filename}
\date{作成日：\filedate}
\begin{document}
  \newcommand\Lpack[1]{\textsf{#1}}
  \maketitle
  \DocInput{\filename}
\end{document}
%</driver>
% \fi
%
% \changes{v1.0}{2016/02/01}{p\LaTeXe 用に\file{latexrelease.dtx}を修正}
% \changes{v1.0a}{2016/02/03}{latexreleaseをもとにplatexreleaseとして拡張}
%
% p\LaTeXe{}がベースにしている\LaTeXe{}は、2015年より前まではカーネルの
% 互換性を失わせる大きな変更は加えられず、修正は\Lpack{fixltx2e}パッケージ
% で提供されていました。しかし、2015年以降は\Lpack{fixltx2e}の変更点が
% すべて\LaTeXe{}のカーネルに取り込まれ、代わりに過去のバージョンの
% \LaTeXe{}をエミュレートするための\Lpack{latexrelease}パッケージが提供
% されるようになりました。
%
% この\Lpack{platexrelease}パッケージは、p\LaTeXe{}で\Lpack{latexrelease}に
% 相当する機能を提供するためのパッケージです。
% 基本的な使い方は
%\begin{verbatim}
% \RequirePackage[2015/01/01]{platexrelease}
% \documentclass{jarticle}
% ....
%\end{verbatim}
% です。\Lpack{latexrelease}の代わりに\Lpack{platexrelease}を読み込まない
% と、p\LaTeXe{}で日本語用に加えた\LaTeXe{}へのパッチがキャンセルされて
% しまう場合がありますので注意してください。\Lpack{latexrelease}の使いかた
% については、\Lpack{latexrelease}のドキュメントを参照してください。
%
% \section{パッケージオプション}
%
% \Lpack{latexrelease}パッケージと同様です。\Lpack{platexrelease}に
% 指定されたオプションは、内部で読み込まれる\Lpack{latexrelease}にも
% そのまま渡ります。
% \begin{itemize}
% \item \emph{yyyy/mm/dd}
% p\LaTeXe{}のフォーマットの日付を指定します。任意の日付を指定でき
% ますが，パッケージよりも未来の日付が指定された場合は警告します。
%
% \item%
% |current| これはデフォルトの挙動です。フォーマットの日付は実効的に
% 変更しませんが、|\plIncludeInRelease|コマンドが定義されることを
% 保証します。
%
% \item
% |latest| フォーマットの日付の実効値を、このファイルのリリース日
% に設定します。したがって、古いフォーマットを使っている場合は
% 現在利用可能なすべてのパッチが適用されます。
% \end{itemize}
%
% \setcounter{StandardModuleDepth}{1}
% \StopEventually{}
%
% \section{コード}
%
% 最初に\Lpack{latexrelease}パッケージを読み込みます。
%    \begin{macrocode}
%<*platexrelease>
\RequirePackageWithOptions{latexrelease}
%    \end{macrocode}
%
% 読み込んだ\Lpack{latexrelease}パッケージのバージョンを確認し、
% \Lpack{platexrelease}が未対応の新しいものであった場合に警告します。
% \changes{v1.0b}{2016/02/16}{latexreleaseのバージョン確認を導入}
%    \begin{macrocode}
\ifnum\expandafter\@parse@version\latexreleaseversion//00\@nil
  >\expandafter\@parse@version\p@known@latexreleaseversion//00\@nil
  \PackageWarningNoLine{platexrelease}{%
    Version of `latexrelease' is newer than\MessageBreak
    what `platexrelease' knows}
\fi
%    \end{macrocode}
%
% \Lpack{platexrelease}パッケージのオプションを定義します。コードは
% \Lpack{latexrelease}のものをp\LaTeXe{}用に書き換えたものです。
%    \begin{macrocode}
\DeclareOption*{%
  \def\@plIncludeInRelease#1[#2]{\@plIncludeInRele@se{#1}}%
  \let\requestedplpatchdate\CurrentOption}
\DeclareOption{latest}{%
  \let\requestedplpatchdate\platexreleaseversion}
\DeclareOption{current}{%
  \let\requestedplpatchdate\pfmtversion}
%    \end{macrocode}
%
%    \begin{macrocode}
\ExecuteOptions{current}
\ProcessOptions\relax
%    \end{macrocode}
%
%    \begin{macrocode}
\def\reserved@a{%
\edef\requestedpLaTeXdate{\the\count@}%
\reserved@b}
\def\reserved@b#1\\{%
\def\reserved@b{#1}%
\ifx\reserved@b\@empty\else
\PackageError{platexrelease}%
             {Unexpected option \requestedplpatchdate}%
             {The option must be of the form yyyy/mm/dd}%
\fi}
\afterassignment\reserved@a
\count@\expandafter
  \@parse@version\expandafter0\requestedplpatchdate//00\@nil\\
%    \end{macrocode}
%
%    \begin{macrocode}
\edef\currentpLaTeXdate{%
   \expandafter\@parse@version\pfmtversion//00\@nil}
%    \end{macrocode}
%
%    \begin{macrocode}
\ifnum\requestedpLaTeXdate=\currentpLaTeXdate
\PackageWarningNoLine{platexrelease}{%
  Current format date selected, no patches applied.}
\expandafter\endinput
\fi
%    \end{macrocode}
%
% より新しいフォーマットに対しては、より新しいバージョンの
% \Lpack{platexrelease}が提供されているはずです。
%    \begin{macrocode}
\ifnum\currentpLaTeXdate
  >\expandafter\@parse@version\platexreleaseversion//00\@nil
\PackageWarningNoLine{platexrelease}{%
The current package is for an older pLaTeX format:\MessageBreak
pLaTeX \pfmtversion\space\MessageBreak
Obtain a newer version of this package!}
\expandafter\endinput
\fi
%    \end{macrocode}
%
% 将来のp\LaTeXe{}をつくりだすパッチはありませんが、オプションは
% 現時点では受け入れます。
%    \begin{macrocode}
\ifnum\requestedpLaTeXdate
  >\expandafter\@parse@version\platexreleaseversion//00\@nil
\PackageWarningNoLine{platexrelease}{%
The current package is for pLaTeX \platexreleaseversion:\MessageBreak
It has no patches beyond that date\MessageBreak
There may be an updated version\MessageBreak
of this package available from CTAN}
\expandafter\endinput
\fi
%    \end{macrocode}
%
% フォーマットのバージョンを要求されている日付に更新します。
%    \begin{macrocode}
\let\pfmtversion\requestedplpatchdate
\let\currentpLaTeXdate\requestedpLaTeXdate
%</platexrelease>
%    \end{macrocode}
%
% このあとは、p\LaTeXe{}のカーネルの変更点を示すコードが入ります。
%
% \Finale
%
\endinput
